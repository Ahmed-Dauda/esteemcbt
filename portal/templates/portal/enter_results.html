{% load static %}
{% block content %}
<h2>Enter Results — {{ class_obj.name }} — {{ subject_obj.title }}</h2>
<p>Term: {{ term }} | Session: {{ session }}</p>

<!-- Search box -->
<div class="mb-3">
  <input type="text" id="student-search" class="form-control" placeholder="Search student by name or username...">
</div>

<form method="post" id="bulk-results-form">
  {% csrf_token %}
  {{ formset.management_form }}

  <!-- Virtual Scroll Container -->
  <div id="scroll-container" style="height:500px; overflow-y:auto; border:1px solid #ccc; position:relative;">
    <table class="table table-sm table-striped" id="results-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Student</th>
          <th>CA (Max: {{ max_ca }})</th>
          <th>Midterm (Max: {{ max_midterm }})</th>
          <th>Exam (Max: {{ max_exam }})</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody id="results-tbody">
        <!-- Rows will be rendered dynamically by JS -->
      </tbody>
    </table>
  </div>

  <div class="mt-3">
    <button type="submit" class="btn btn-success">Save All</button>
    <a href="{% url 'portal:enter_select' %}" class="btn btn-secondary">Back</a>
  </div>
</form>

<script>
const maxCA = parseFloat("{{ max_ca }}");
const maxMid = parseFloat("{{ max_midterm }}");
const maxExam = parseFloat("{{ max_exam }}");

// Data for virtual table
const studentsData = [
  {% for form, student in forms_with_students %}
  {
    id: {{ student.id }},
    name: "{{ student.get_full_name|default:student.username }}",
    ca_score: "{{ form.initial.ca_score|default_if_none:'0.00' }}",
    mid_score: "{{ form.initial.midterm_score|default_if_none:'0.00' }}",
    exam_score: "{{ form.initial.exam_score|default_if_none:'0.00' }}",
  },
  {% endfor %}
];

// Config
const rowHeight = 40; // approximate row height
const container = document.getElementById('scroll-container');
const tbody = document.getElementById('results-tbody');
let visibleRows = Math.ceil(container.offsetHeight / rowHeight) + 5;
let scrollTop = 0;
let filterText = '';

// --- Functions ---
function createRow(student, index) {
  const tr = document.createElement('tr');
  tr.style.height = rowHeight + 'px';
  tr.dataset.studentId = student.id;

  tr.innerHTML = `
    <td>${index + 1}</td>
    <td class="student-name">
      ${student.name}
      <input type="hidden" name="form-${index}-student_id" value="${student.id}">
      <input type="hidden" name="form-${index}-existing_result_id" value="">
    </td>
    <td><input type="number" step="0.01" name="form-${index}-ca_score" value="${student.ca_score}" class="form-control form-control-sm"></td>
    <td><input type="number" step="0.01" name="form-${index}-midterm_score" value="${student.mid_score}" class="form-control form-control-sm"></td>
    <td><input type="number" step="0.01" name="form-${index}-exam_score" value="${student.exam_score}" class="form-control form-control-sm"></td>
    <td class="row-total">0.00</td>
  `;
  return tr;
}

function updateRowTotal(tr) {
  const caInput = tr.querySelector('input[name$="ca_score"]');
  const midInput = tr.querySelector('input[name$="midterm_score"]');
  const examInput = tr.querySelector('input[name$="exam_score"]');
  const totalCell = tr.querySelector('.row-total');

  [caInput, midInput, examInput].forEach(input => {
    input.style.borderColor = '';
    input.style.backgroundColor = '';
  });

  let ca = parseFloat(caInput.value || 0);
  let mid = parseFloat(midInput.value || 0);
  let exam = parseFloat(examInput.value || 0);

  function showWarning(input, msg) {
    input.value = '';
    input.style.borderColor = 'red';
    input.style.backgroundColor = '#ffe6e6';
    alert(msg);
  }

  if (ca > maxCA) showWarning(caInput, `CA cannot exceed ${maxCA}`);
  if (mid > maxMid) showWarning(midInput, `Midterm cannot exceed ${maxMid}`);
  if (exam > maxExam) showWarning(examInput, `Exam cannot exceed ${maxExam}`);

  if (totalCell) totalCell.textContent = (ca + mid + exam).toFixed(2);
}

function renderVisibleRows() {
  tbody.innerHTML = '';
  const startIdx = Math.floor(container.scrollTop / rowHeight);
  const endIdx = Math.min(startIdx + visibleRows, studentsData.length);
  const filteredData = studentsData.filter(s => s.name.toLowerCase().includes(filterText));
  for (let i = startIdx; i < endIdx; i++) {
    const student = filteredData[i];
    if (student) {
      const tr = createRow(student, i);
      updateRowTotal(tr);
      tbody.appendChild(tr);
    }
  }
  tbody.style.height = (filteredData.length * rowHeight) + 'px';
}

// --- Event Listeners ---
container.addEventListener('scroll', renderVisibleRows);
container.addEventListener('input', e => {
  const tr = e.target.closest('tr');
  if (!tr) return;
  updateRowTotal(tr);
});

// Search filter
const searchInput = document.getElementById('student-search');
let searchTimeout;
searchInput.addEventListener('input', () => {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => {
    filterText = searchInput.value.toLowerCase();
    renderVisibleRows();
  }, 200);
});

// Initialize
renderVisibleRows();
</script>
{% endblock %}
