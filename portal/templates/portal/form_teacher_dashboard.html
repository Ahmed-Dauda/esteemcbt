<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Form Teacher Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">

<h2 class="mb-4">Form Teacher â€“ Behavior & Comments</h2>

<!-- FILTER BAR -->
<!-- FILTER BAR -->
<form method="get" class="row g-3 mb-4">

    <!-- SESSION FILTER -->
    <div class="col-md-3">
        <label class="form-label fw-bold">Session</label>
        <select name="session" class="form-select" required>
            <option value="">-- Select --</option>
            {% for s in sessions %}
                <option value="{{ s.id }}" 
                    {% if selected_session|stringformat:"s" == s.id|stringformat:"s" %}selected{% endif %}>
                    {{ s.name }}
                </option>
            {% endfor %}
        </select>
    </div>

    <!-- TERM FILTER -->
    <div class="col-md-3">
        <label class="form-label fw-bold">Term</label>
        <select name="term" class="form-select" required>
            <option value="">-- Select --</option>
            {% for t in terms %}
                <option value="{{ t.id }}"
                    {% if selected_term|stringformat:"s" == t.id|stringformat:"s" %}selected{% endif %}>
                    {{ t.name }}
                </option>
            {% endfor %}
        </select>
    </div>

    <!-- CLASS FILTER (Only teacherâ€™s classes) -->
    <div class="col-md-3">
        <label class="form-label fw-bold">Class</label>
        <select name="class" class="form-select" required>
            <option value="">-- Select --</option>
            {% for cls in classes %}
                <option value="{{ cls.id }}" 
                    {% if selected_class|stringformat:"s" == cls.id|stringformat:"s" %}selected{% endif %}>
                    {{ cls.name }}
                </option>
            {% endfor %}
        </select>
    </div>

    <!-- SEARCH BUTTON -->
    <div class="col-md-3 d-flex align-items-end">
        <button class="btn btn-primary w-100">Search</button>
    </div>
</form>

{% if records %}
<form method="post">
    {% csrf_token %}

    <div class="table-responsive">
        <table class="table table-bordered table-hover align-middle">
            <thead class="table-dark text-center">
                <tr>
                    <th>Student</th>
                    <th>Psychomotor</th>
                    <th>Affective</th>
                    <th>Report Card</th>
                    <th>Form Teacher Comment</th>
                    <th>AI</th>
                </tr>
            </thead>
            <tbody>
                {% for r in records %}
                <tr>
                    <td class="fw-bold">{{ r.student.first_name }} {{ r.student.last_name }}</td>

                    <!-- Psychomotor Inputs -->
                    <td>
                        <input type="number" name="handwriting_{{ r.student.id }}" value="{{ r.handwriting }}" class="form-control mb-1" placeholder="H/W">
                        <input type="number" name="games_{{ r.student.id }}" value="{{ r.games }}" class="form-control mb-1" placeholder="Games">
                        <input type="number" name="sports_{{ r.student.id }}" value="{{ r.sports }}" class="form-control mb-1" placeholder="Sports">
                        <input type="number" name="drawing_{{ r.student.id }}" value="{{ r.drawing_painting }}" class="form-control mb-1" placeholder="Drawing">
                        <input type="number" name="crafts_{{ r.student.id }}" value="{{ r.crafts }}" class="form-control" placeholder="Crafts">
                    </td>

                    <!-- Affective Inputs -->
                    <td>
                        <input type="number" name="punctuality_{{ r.student.id }}" value="{{ r.punctuality }}" class="form-control mb-1" placeholder="Punctuality">
                        <input type="number" name="attendance_{{ r.student.id }}" value="{{ r.attendance }}" class="form-control mb-1" placeholder="Attendance">
                        <input type="number" name="reliability_{{ r.student.id }}" value="{{ r.reliability }}" class="form-control mb-1" placeholder="Reliability">
                        <input type="number" name="neatness_{{ r.student.id }}" value="{{ r.neatness }}" class="form-control mb-1" placeholder="Neatness">
                        <input type="number" name="politeness_{{ r.student.id }}" value="{{ r.politeness }}" class="form-control mb-1" placeholder="Politeness">
                        <input type="number" name="honesty_{{ r.student.id }}" value="{{ r.honesty }}" class="form-control mb-1" placeholder="Honesty">
                        <input type="number" name="relationship_{{ r.student.id }}" value="{{ r.relationship_with_students }}" class="form-control mb-1" placeholder="Relationship">
                        <input type="number" name="self_control_{{ r.student.id }}" value="{{ r.self_control }}" class="form-control mb-1" placeholder="Self-Control">
                        <input type="number" name="attentive_{{ r.student.id }}" value="{{ r.attentiveness }}" class="form-control mb-1" placeholder="Attentive">
                        <input type="number" name="perseverance_{{ r.student.id }}" value="{{ r.perseverance }}" class="form-control" placeholder="Perseverance">
                    </td>

                    <!-- Report Card -->
                    <td>
                        {% if r.results %}
                            <small>
                                {% for res in r.results %}
                                    {{ res.subject.title }}: {{ res.total_score }} ({{ res.grade_letter }})<br>
                                {% endfor %}
                                <strong>Total:</strong> {{ r.total_score }}<br>
                                <strong>Average:</strong> {{ r.average_score }}<br>
                                <strong>Final Grade:</strong> {{ r.final_grade }}
                            </small>
                        {% else %}
                            <small class="text-muted">No results recorded</small>
                        {% endif %}
                    </td>

                    <!-- Form Teacher Comment -->
                    <td>
                        <textarea id="comment-{{ r.student.id }}" name="comment_{{ r.student.id }}" class="form-control" rows="3">{{ r.form_teacher_comment }}</textarea>
                    </td>

                    <!-- AI Generate -->
                    <td class="text-center">
                        <button type="button" class="btn btn-outline-info btn-sm"
                                onclick="generateFTComment('{{ r.student.id }}')">ðŸ¤– Generate</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <button type="submit" class="btn btn-success mt-3">ðŸ’¾ Save All</button>
</form>

<script>
function generateFTComment(studentId) {
    const box = document.getElementById("comment-" + studentId);
    box.value = "Generating...";

    // Collect psychomotor and affective inputs
    const getValue = (field) => document.querySelector(`[name="${field}_${studentId}"]`).value || 0;

    const params = new URLSearchParams({
        session: "{{ selected_session }}",
        term: "{{ selected_term }}",
        class: "{{ selected_class }}",
        handwriting: getValue('handwriting'),
        games: getValue('games'),
        sports: getValue('sports'),
        drawing: getValue('drawing'),
        crafts: getValue('crafts'),
        punctuality: getValue('punctuality'),
        attendance: getValue('attendance'),
        reliability: getValue('reliability'),
        neatness: getValue('neatness'),
        politeness: getValue('politeness'),
        honesty: getValue('honesty'),
        relationship: getValue('relationship'),
        self_control: getValue('self_control'),
        attentive: getValue('attentive'),
        perseverance: getValue('perseverance')
    });

    fetch(`/portal/generate-form-teacher-comment/${studentId}/?${params.toString()}`)
        .then(res => res.json())
        .then(data => box.value = data.comment)
        .catch(() => box.value = "Error generating comment.");
}
</script>
{% endif %}

</body>
</html>
