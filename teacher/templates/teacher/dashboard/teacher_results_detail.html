{% extends 'sms/dashboard/teacherbase.html' %}

{% block title %} See and Export Results {% endblock %}

{% block content %}

<div class="container-fluid mt-4">

<!-- FORM FOR BULK DELETE -->
<form method="POST" action="" class="mb-3">
  {% csrf_token %}

  <button type="submit" class="btn btn-danger me-2" id="delete-btn">
      <i class="fas fa-trash"></i> Delete Selected
  </button>

  <a href="{% url 'teacher:export_results_csv' %}" class="btn btn-primary">
      <i class="fas fa-file-csv"></i> Export to CSV
  </a>

  <h2 class="mt-4 mb-3">Results for {{ course.course_name }}</h2>

  <div class="table-responsive">
    <table id="resultsTable" class="table table-striped table-bordered">
      <thead class="table-dark">
        <tr>
          <th><input type="checkbox" id="select-all"></th>
          <th>Student</th>
          <th>Marks</th>
          <th>Result Class</th>
          <th>Session</th>
          <th>Term</th>
          <th>Exam Type</th>
          <th>Created</th>
          <th>Action</th>
        </tr>
      </thead>

      <tbody>
        {% for result in results %}
        <tr>
          <td>
            <input type="checkbox" name="selected_results" value="{{ result.id }}" class="check-item">
          </td>

          <td>{{ result.student.first_name }} {{ result.student.last_name }}</td>
          <td>{{ result.marks }}</td>
          <td>{{ result.result_class }}</td>
          <td>{{ result.session.name }}</td>
          <td>{{ result.term.name }}</td>
          <td>{{ result.exam_type.name }}</td>
          <td>{{ result.created|date:"Y-m-d H:i" }}</td>

          <td>
            <a href="{% url 'teacher:edit_teacher_results' course.id result.id %}"
               class="btn btn-sm btn-warning mb-1">Edit</a>

            <a href="{% url 'teacher:delete_teacher_result' course.id result.id %}"
               class="btn btn-sm btn-danger"
               onclick="return confirm('Are you sure you want to delete this result?');">Delete</a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="9" class="text-center">No results available for this course.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</form>

<a href="{% url 'teacher:teacher_results' %}" class="btn btn-secondary mt-3">‚Üê Back to result list</a>

</div>


<!-- ========================= SCRIPTS ========================= -->

<script>
  $(document).ready(function () {

    // Initialize DataTables first
    let table = $('#resultsTable').DataTable({
      "order": [[1, "asc"]],  // sort by student name
      "pageLength": 10
    });

    // SELECT ALL
    $('#select-all').on('click', function () {
      $('input.check-item').prop('checked', this.checked);
    });

    // BULK DELETE CONFIRMATION WITH COUNT
    $('#delete-btn').on('click', function (e) {
      let count = $('input.check-item:checked').length;

      if (count === 0) {
        alert("No results selected to delete.");
        e.preventDefault();
        return false;
      }

      let confirmMsg = `Are you sure you want to delete ${count} selected result(s)?`;

      if (!confirm(confirmMsg)) {
        e.preventDefault();
        return false;
      }
    });

  });
</script>

{% endblock %}
