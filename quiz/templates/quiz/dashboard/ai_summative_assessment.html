{% load static %}
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>AI Summative Assessment</title>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <style>
    body { font-family: Arial; margin: 20px; }
    .form-section { max-width: 800px; margin: auto; }
    .form-group { margin-bottom: 15px; }
    label { display: block; font-weight: bold; margin-bottom: 5px; }
    input[type="text"], textarea, select { width: 100%; padding: 8px; }
    button { padding: 10px 20px; cursor: pointer; }
    .question-block { border: 1px solid #ddd; margin-bottom: 10px; padding: 10px; border-radius:5px;}
    #loader-container { display:none; margin-top:20px; text-align:center; }
    #progress-wrapper { background:#eee; width:100%; height:20px; border-radius:5px; overflow:hidden; margin-top:5px; }
    #progress-bar { width:0%; height:100%; background:#4caf50; border-radius:5px; transition: width 0.3s; }

    /* Toast popup styles */
    #toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }
    .toast-message {
      min-width: 250px;
      margin-bottom: 10px;
      padding: 12px 20px;
      border-radius: 5px;
      color: #fff;
      font-size: 14px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      opacity: 0.95;
      animation: fadein 0.5s, fadeout 0.5s 3.5s;
    }
    .toast-success { background-color: #28a745; }
    .toast-warning { background-color: #ffc107; color: #212529; }
    .toast-error   { background-color: #dc3545; }

    @keyframes fadein { from {opacity: 0; transform: translateY(-20px);} to {opacity: 0.95; transform: translateY(0);} }
    @keyframes fadeout { from {opacity: 0.95;} to {opacity: 0; transform: translateY(-20px);} }
  </style>
</head>
<body>

<!-- Toast container -->
<div id="toast-container"></div>

<div class="form-section">


  <h2>ü§ñ Generate Questions with AI</h2>
  <a href="{% url 'quiz:teacher_subjects' %}">
  <button class="btn-primary">View Questions</button>
  </a>
  

  <form id="generate-form" method="POST">
    {% csrf_token %}
    <div class="form-group">
      <h3>Instructions</h3>
      <p>Select the subject and enter learning objectives, assign the number of questions and difficulty level and click generate.</p>
      <label>Select Subject:</label>
      <select id="course" name="course" required>
        {% for c in courses %}
          <option value="{{ c.id }}">{{ c.course_name }}</option>
        {% endfor %}
      </select>
    </div>
  
  
  
    <div class="form-group">
  <label>Learning Objectives:</label>
  <textarea id="learning_objectives"
            name="learning_objectives"
            rows="6"
            placeholder="Enter learning objectives..."
            required></textarea>

  <!-- <h4>Activate Mathematics, Chemistry, or Physics Question Format.Only for secondary and tertiary levels.</h4>
<button type="button"
        class="btn btn-primary mt-2"
        onclick="activation(); addMathMLQuestion();">
  Active mode
</button>
<style>
math {
  display: inline-block;
  font-size: 1.2em;
  vertical-align: middle;
}
</style>

</div>

<script>
function   activation(){
  alert("Mathematics, Chemistry, or Physics Question Format Activated. Please enter your learning objectives below separated by commas.");
}

function addMathMLQuestion() {
  const questionBlock = `
Make sure Both questions and options should be formatted as valid mathml url format strictly. 
Example: 
    "question":"<math xmlns='http://www.w3.org/1998/Math/MathML'><msup><mi>v</mi><mn>2</mn></msup><mo>=</mo><msup><mi>u</mi><mn>2</mn></msup><mo>+</mo><mn>2</mn><mi>a</mi><mi>s</mi></math>",    
    "option1": "<math xmlns='http://www.w3.org/1998/Math/MathML'><mfrac><mn>3</mn><mn>5</mn></mfrac></math>",
    "option2": "<math xmlns='http://www.w3.org/1998/Math/MathML'><mfrac><mn>5</mn><mn>6</mn></mfrac></math>",
    "option3": "<math xmlns='http://www.w3.org/1998/Math/MathML'><mfrac><mn>7</mn><mn>6</mn></mfrac></math>",
    "option4": "<math xmlns='http://www.w3.org/1998/Math/MathML'><mfrac><mn>8</mn><mn>9</mn></mfrac></math>",
`;


  const textarea = document.getElementById("learning_objectives");
textarea.value += '\n\n\n\n\n\n\n\n' + questionBlock; // adds top padding visually

}
</script> -->


    <!-- <div class="form-group">
      <label>Learning Objectives:</label>
      <textarea id="learning_objectives" name="learning_objectives" rows="4" placeholder="Enter learning objectives..." required></textarea>
    </div> -->

    <div class="form-group">
      <label>Number of Questions:</label>
      <input type="number" id="num_questions" name="num_questions" value="5" min="1" required>
    </div>

    <div class="form-group">
      <label>Difficulty Level:</label>
      <select id="difficulty" name="difficulty">
        <option value="very_easy">Very Easy</option>
        <option value="easy">Easy</option>
        <option value="medium" selected>Medium</option>
        <option value="hard">Hard</option>
        <option value="very_hard">Very Hard</option>
      </select>
    </div>

    <div style="text-align:center;">
      <button type="submit" id="generate-btn">‚öôÔ∏è Generate Questions</button>
    </div>
  </form>

  <div id="loader-container">
    <p>Generating questions‚Ä¶ <span id="progress_text"></span></p>
    <div id="progress-wrapper">
      <div id="progress-bar"></div>
    </div>
  </div>

  <div id="preview-area" style="margin-top:20px;"></div>
  <div id="preview-save-container"></div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
$(document).ready(function() {
  $('#course').select2({width:'100%'});
  $('#difficulty').select2({width:'100%'});

  const csrftoken = '{{ csrf_token }}';

  function showMessage(message, type='success') {
    const toast = $(`<div class="toast-message toast-${type}">${message}</div>`);
    $('#toast-container').append(toast);
    setTimeout(() => toast.fadeOut(600, () => toast.remove()), 4000);
  }

  $('#generate-form').on('submit', function(e){
    e.preventDefault();
    $('#generate-btn').prop('disabled', true);
    $('#loader-container').show();
    $('#preview-area, #preview-save-container').empty();

    const data = {
      course: $('#course').val(),
      learning_objectives: $('#learning_objectives').val(),
      num_questions: $('#num_questions').val(),
      difficulty: $('#difficulty').val()
    };

    fetch("{% url 'quiz:ai_generate_api' %}", {
      method:'POST',
      headers: {'Content-Type':'application/json','X-CSRFToken':csrftoken},
      body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(resp => {
      if(resp.job_id) pollStatus(resp.job_id, parseInt(data.num_questions));
      else { showMessage('Failed to start generation', 'error'); $('#loader-container').hide(); $('#generate-btn').prop('disabled',false); }
    })
    .catch(err => { console.error(err); showMessage('Error generating questions', 'error'); $('#loader-container').hide(); $('#generate-btn').prop('disabled',false); });
  });

  function pollStatus(jobId, totalQuestions){
    fetch(`/quiz/api/job-status/${jobId}/`)
      .then(r=>r.json())
      .then(data=>{
        if(data.status==='processing'){
          const partial = data.result?.partial_count || 0;
          const percent = Math.min(100, (partial/totalQuestions)*100);
          $('#progress-bar').css('width',percent+'%');
          $('#progress_text').text(`${partial}/${totalQuestions} generated`);
          setTimeout(()=>pollStatus(jobId,totalQuestions),1500);
        } 
        else if(data.status==='completed'){
          $('#loader-container').hide();
          $('#generate-btn').prop('disabled',false);
          renderPreview(data.result.questions || []);
        } 
        else if(data.status==='failed'){
          showMessage('Generation failed: ' + (data.error||'unknown'), 'error');
          $('#loader-container').hide();
          $('#generate-btn').prop('disabled',false);
        } 
        else setTimeout(()=>pollStatus(jobId,totalQuestions),1500);
      })
      .catch(()=>setTimeout(()=>pollStatus(jobId,totalQuestions),3000));
  }

  function renderPreview(questions){
    if(!questions.length){ 
      $('#preview-area').html('<p>No questions returned</p>'); 
      return; 
    }

    let html = `<div class="form-section"><h3>‚úèÔ∏è Review Questions Before Saving</h3>
      <form id="preview-save-form" method="POST">
      <input type="hidden" name="confirm_save" value="1">
      <input type="hidden" name="course_id" value="${$('#course').val()}">
      <input type="hidden" name="total_questions" value="${questions.length}">
      <input type="hidden" name="marks" value="1">
      <input type="hidden" name="difficulty" value="${$('#difficulty').val()}">`;

    questions.forEach((q,i)=>{
      const idx=i+1;
      html+=`<div class="question-block">
        <div class="form-group"><label>Question ${idx}</label>
        <textarea name="question_${idx}" rows="2">${escapeHtml(q.question)}</textarea></div>
        <div class="form-group"><label>Option A:</label><input type="text" name="option1_${idx}" value="${escapeHtml(q.option1)}"></div>
        <div class="form-group"><label>Option B:</label><input type="text" name="option2_${idx}" value="${escapeHtml(q.option2)}"></div>
        <div class="form-group"><label>Option C:</label><input type="text" name="option3_${idx}" value="${escapeHtml(q.option3)}"></div>
        <div class="form-group"><label>Option D:</label><input type="text" name="option4_${idx}" value="${escapeHtml(q.option4)}"></div>
        <div class="form-group"><label>Correct Answer:</label>
          <select name="answer_${idx}">
            <option value="Option1" ${q.answer==='Option1'?'selected':''}>A</option>
            <option value="Option2" ${q.answer==='Option2'?'selected':''}>B</option>
            <option value="Option3" ${q.answer==='Option3'?'selected':''}>C</option>
            <option value="Option4" ${q.answer==='Option4'?'selected':''}>D</option>
          </select>
        </div></div>`;
    });


    html+=`<div style="text-align:center;"><button type="submit">‚úÖ Save All Questions</button></div></form></div>`;
    $('#preview-save-container').html(html);

    $('#preview-save-form').off('submit').on('submit', function(e){
      e.preventDefault();
      const formData = new FormData(this);
      formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

      fetch("{% url 'quiz:ai_summative_assessment' %}", {
        method:'POST',
        body: formData,
        headers: {'X-Requested-With': 'XMLHttpRequest'}
      })
      .then(r => r.json())
      .then(resp => {
        showMessage(resp.message, resp.status || 'success');
      })
      .catch(err => { console.error(err); showMessage('Error saving questions', 'error'); });
    });
  }

  function escapeHtml(text){
    if(!text) return '';
    return text.replaceAll("&","&amp;")
               .replaceAll("<","&lt;")
               .replaceAll(">","&gt;")
               .replaceAll('"',"&quot;")
               .replaceAll("'","&#039;");
  }
});
</script>

</body>
</html>
